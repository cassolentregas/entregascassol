<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprovante de Entrega Digital</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* CSS BÁSICO */
        :root { --cor-principal: #007BFF; --cor-fundo: #F7F7F7; --cor-texto: #333333; }
        body { font-family: Arial, sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: var(--cor-principal); border-bottom: 2px solid var(--cor-principal); padding-bottom: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="email"], input[type="password"], textarea, input[type="file"], button, select { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: var(--cor-principal); color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #signature-pad { width: 100%; height: 200px; border: 1px solid #ccc; margin-bottom: 15px; background-color: #EEEEEE;}
        .hidden { display: none; }

        /* Estilos do Painel/Gerente */
        .pedido-card { 
            border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; 
            cursor: pointer; background-color: #f9f9f9; transition: background-color 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .pedido-card:hover { background-color: #e0e0e0; }
        .delete-btn { width: auto; padding: 5px 10px; margin-left: 10px; background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .aprovacao-card { border: 1px solid #ffc107; padding: 10px; margin-bottom: 10px; background-color: #fff3cd; }
        .aprovacao-card button { width: auto; margin: 5px 5px 0 0; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="login-area">
            <h2>Acesso ao Sistema</h2>
            <input type="email" id="login-email" placeholder="E-mail" required>
            <input type="password" id="login-senha" placeholder="Senha" required>
            <button onclick="handleLogin()">Entrar</button>
            <p style="text-align: center; margin-top: 15px;"><a href="#" onclick="showRegister()">Não tem conta? Cadastre-se</a></p>
        </div>

        <div id="cadastro-area" class="hidden">
            <h2>Cadastro de Novo Usuário</h2>
            <input type="text" id="reg-nome" placeholder="Seu Nome Completo" required>
            <input type="email" id="reg-email" placeholder="Seu E-mail" required>
            <input type="password" id="reg-senha" placeholder="Crie uma Senha (mín. 6 caracteres)" required>
            
            <label for="reg-nivel" style="display: block; margin-bottom: 5px;">Seu Cargo:</label>
            <select id="reg-nivel" required>
                <option value="1">Entregador</option>
                <option value="2">Gerente</option>
            </select>
            
            <button onclick="handleRegister()">Cadastrar e Aguardar Aprovação</button>
            <p style="text-align: center; margin-top: 15px;"><a href="#" onclick="showLogin()">Voltar ao Login</a></p>
        </div>


        <div id="entregador-area" class="hidden">
            <h2>Área do Entregador</h2>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="tab-registro-btn" style="width: 100%; background-color: #007bff;">Registro de Entregas</button>
            </div>

            <div id="tab-registro-content" class="tab-content">
                <h3>Registro de Entrega</h3>
                
                <input type="text" id="pedido" placeholder="Número do Pedido" required>
                <textarea id="endereco" placeholder="Endereço da Entrega" rows="2" required></textarea>
                <input type="text" id="cliente" placeholder="Nome do Recebedor" required>
                
                <label>Fotos da Entrega (mínimo 1):</label>
                <div id="photos-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;"></div>
                <input type="file" id="single-photo-input" accept="image/*" capture="camera" class="hidden">
                <button type="button" onclick="document.getElementById('single-photo-input').click()">Adicionar Nova Foto</button>
                <div id="photo-status" style="margin-bottom: 15px; color: #dc3545;"></div> 

                <label>Assinatura do Cliente:</label>
                <canvas id="signature-pad"></canvas>
                <button type="button" onclick="signaturePad.clear()">Limpar Assinatura</button>
                <br><br>
                
                <button onclick="submitDelivery()">Registrar Entrega</button>
            </div>
        </div>

        <div id="gerente-area" class="hidden">
            <h2>Painel de Gerenciamento</h2>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="tab-historico-btn" onclick="showGerenteTab('historico')" style="width: auto; background-color: #007bff;">Histórico</button>
                <button id="tab-aprovacao-btn" onclick="showGerenteTab('aprovacao')" style="width: auto; background-color: #0056b3;">Aprovações</button>
            </div>

            <div id="tab-historico-content" class="tab-content">
                <h3>Histórico de Entregas</h3>
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="text" id="search-input" placeholder="Buscar por Número do Pedido..." onkeyup="searchDeliveries()">
                    <button onclick="deleteAllDeliveries()" style="width: auto; background-color: #dc3545;">Excluir TUDO</button>
                </div>
                <div id="historico-list">
                    <p>Carregando histórico...</p>
                </div>
                <hr style="margin: 20px 0;">
                <div id="detalhes-pedido" style="padding: 15px; border: 1px solid var(--cor-principal); border-radius: 4px;" class="hidden">
                    <h3>Detalhes do Pedido <span id="pedido-numero-detalhe"></span></h3>
                    <button onclick="downloadComprovante()" id="download-btn" style="width: auto; margin-bottom: 20px; background-color: #28a745;">
                        Baixar Comprovante (PDF)
                    </button>
                    <div id="detalhes-conteudo"></div>
                </div>
            </div>

            <div id="tab-aprovacao-content" class="tab-content hidden">
                <div style="border: 2px solid #ffc107; padding: 15px; margin-bottom: 25px; border-radius: 4px;">
                    <h3>Aprovação de Usuários Pendentes</h3>
                    <div id="aprovacao-list">
                        <p>Carregando solicitações...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="handleLogout()" style="margin-top: 20px;">Sair</button>
    </div>

    <script>
// ** 1. Configuração do Supabase **
const SUPABASE_URL = 'https://myfqnrxjhmuilotxbtnq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZnFucnhqaG11aWxvdHhidG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTAxOTAsImV4cCI6MjA3NTI4NjE5MH0.ZB9PZq5nxQuFON0e46qXHpNuU4DTofneXjWvf486qww';

const BUCKET_NAME = 'comprovantes';
const ENTREGAS_TABLE = 'entregas'; 
const FOTOS_TABLE = 'fotos_comprovantes'; 
const PERFIS_TABLE = 'perfis'; 
const MENSAGENS_TABLE = 'mensagens'; // Mantido para referência

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null; 
let photosToUpload = []; 
let currentChatPartnerId = null; 
let unsubscribeRealtime = null; 

// ** 2. Configuração da Assinatura e Canvas **
const canvas = document.getElementById('signature-pad');
const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(238, 238, 238)' });
function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    signaturePad.clear();
}

// ** MUDANÇA CRÍTICA: Chama checkUserSession ao carregar a página **
window.onload = function() {
    resizeCanvas();
    checkUserSession(); 
    // Ativa o listener para a nova função de foto sequencial
    document.getElementById('single-photo-input').addEventListener('change', addPhotoFromInput);
};
window.addEventListener('resize', resizeCanvas);


// Funções Auxiliares de UI
function showRegister() {
    document.getElementById('login-area').classList.add('hidden');
    document.getElementById('cadastro-area').classList.remove('hidden');
}
function showLogin() {
    document.getElementById('login-area').classList.remove('hidden');
    document.getElementById('cadastro-area').classList.add('hidden');
}
// Navegação do Gerente
function showGerenteTab(tabName) {
    const tabs = ['aprovacao', 'historico'];
    const activeColor = '#007bff';
    const inactiveColor = '#0056b3';

    tabs.forEach(tab => {
        document.getElementById(`tab-${tab}-content`).classList.add('hidden');
        document.getElementById(`tab-${tab}-btn`).style.backgroundColor = inactiveColor;
    });

    document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
    document.getElementById(`tab-${tabName}-btn`).style.backgroundColor = activeColor;

    if (tabName === 'aprovacao') loadAprovacaoPanel();
    if (tabName === 'historico') fetchDeliveries();
}

// ** 3. Lógica de Persistência, Cadastro e Login **

async function checkUserSession() {
    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
        const { data: profileData, error: profileError } = await supabase
            .from(PERFIS_TABLE)
            .select('status, nivel_acesso, email')
            .eq('id', user.id)
            .single();

        if (profileError || profileData.status !== 'APROVADO') {
            await supabase.auth.signOut();
            showLogin();
            return;
        }

        currentUser = { id: user.id, nivel: profileData.nivel_acesso, email: profileData.email };
        document.getElementById('login-area').classList.add('hidden');
        document.getElementById('cadastro-area').classList.add('hidden');

        if (currentUser.nivel === 1) {
            document.getElementById('entregador-area').classList.remove('hidden');
        } else if (currentUser.nivel === 2) {
            document.getElementById('gerente-area').classList.remove('hidden');
            showGerenteTab('historico'); // Gerente começa no Histórico
        }
    } else {
        showLogin();
    }
}

// MODIFICADA: Inserção Direta do Perfil após Sign Up
async function handleRegister() {
    const nome = document.getElementById('reg-nome').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const senha = document.getElementById('reg-senha').value.trim();
    const nivel = parseInt(document.getElementById('reg-nivel').value);
    
    if (!nome || !email || senha.length < 6) {
        return alert("Preencha todos os campos e use uma senha de no mínimo 6 caracteres.");
    }
    
    // 1. Cadastrar o usuário no Supabase Auth
    const { data, error: signUpError } = await supabase.auth.signUp({
        email: email,
        password: senha,
        options: {
            data: { nome: nome, nivel: nivel }
        }
    });

    if (signUpError) {
        if (signUpError.message.includes('already registered')) {
            return alert('Este e-mail já está cadastrado. Tente fazer login.');
        }
        return alert('Erro ao cadastrar. Tente novamente.');
    }
    
    // 2. INSERÇÃO DIRETA DO PERFIL PENDENTE (Substituindo o Trigger)
    if (data.user) {
        const { error: profileInsertError } = await supabase
            .from(PERFIS_TABLE)
            .insert([{
                id: data.user.id,
                email: data.user.email,
                nivel_acesso: nivel, 
                status: 'PENDENTE'
            }]);
        
        if (profileInsertError) {
             console.error('Erro de inserção direta do perfil:', profileInsertError);
             // Embora seja um erro crítico, o usuário já foi criado no Auth, então damos o aviso.
             alert('Erro crítico ao salvar seu perfil PENDENTE. Contate o administrador.');
             await supabase.auth.signOut();
             return;
        }
    }

    // 3. Desloga o usuário e informa a pendência
    await supabase.auth.signOut();
    alert("Cadastro enviado com sucesso! Sua conta está PENDENTE de aprovação do administrador.");
    showLogin(); 
}

async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const senha = document.getElementById('login-senha').value.trim();

    const { data, error: signInError } = await supabase.auth.signInWithPassword({
        email: email,
        password: senha,
    });

    if (signInError) {
        return alert('Falha no login. Verifique e-mail e senha.');
    }

    const userId = data.user.id;

    const { data: profileData, error: profileError } = await supabase
        .from(PERFIS_TABLE)
        .select('status, nivel_acesso, email')
        .eq('id', userId)
        .single();
    
    if (profileError || !profileData) {
        return alert('Seu perfil não foi encontrado. Contate o administrador. (Verifique RLS de SELECT na tabela PERFIS).');
    }

    if (profileData.status !== 'APROVADO') {
        await supabase.auth.signOut(); 
        return alert(`Sua conta está no status: ${profileData.status}. Aguarde a aprovação do administrador.`);
    }

    currentUser = { id: userId, nivel: profileData.nivel_acesso, email: profileData.email };
    document.getElementById('login-area').classList.add('hidden');
    document.getElementById('cadastro-area').classList.add('hidden');
    
    if (currentUser.nivel === 1) {
        document.getElementById('entregador-area').classList.remove('hidden');
    } else if (currentUser.nivel === 2) {
        document.getElementById('gerente-area').classList.remove('hidden');
        showGerenteTab('historico'); 
    }
}

async function handleLogout() {
    if (unsubscribeRealtime) {
        unsubscribeRealtime.unsubscribe(); 
    }
    await supabase.auth.signOut();
    currentUser = null;
    showLogin();
    document.getElementById('entregador-area').classList.add('hidden');
    document.getElementById('gerente-area').classList.add('hidden');
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
}

// ** 4. Lógica do Painel de Aprovação (Gerente/Nível 2) **

async function loadAprovacaoPanel() {
    const listDiv = document.getElementById('aprovacao-list');
    listDiv.innerHTML = 'Carregando solicitações...';
    
    const { data, error } = await supabase
        .from(PERFIS_TABLE)
        .select('id, email, nivel_acesso, created_at') 
        .eq('status', 'PENDENTE')
        .order('created_at', { ascending: true }); 

    if (error) {
        console.error('Erro ao carregar lista de aprovação:', error);
        listDiv.innerHTML = 'Erro ao carregar lista. Verifique a Política RLS de SELECT na tabela "perfis".';
        return;
    }

    if (data.length === 0) {
        listDiv.innerHTML = '<p>Nenhuma solicitação de usuário pendente.</p>';
        return;
    }

    listDiv.innerHTML = ''; 
    data.forEach(profile => {
        const nivelText = profile.nivel_acesso == 2 ? 'Gerente' : 'Entregador';
        const card = document.createElement('div');
        card.className = 'aprovacao-card';
        card.innerHTML = `
            <p><strong>E-mail:</strong> ${profile.email}</p>
            <p><strong>Cargo Solicitado:</strong> ${nivelText}</p>
            <button onclick="aproveOrReject('${profile.id}', 'APROVADO', ${profile.nivel_acesso})">Aprovar e Ativar</button>
            <button onclick="aproveOrReject('${profile.id}', 'REJEITADO', 0)" style="background-color: #6c757d;">Rejeitar</button>
        `;
        listDiv.appendChild(card);
    });
}

async function aproveOrReject(userId, newStatus, currentNivel) {
    if (!confirm(`Confirmar a ação: ${newStatus} para o usuário?`)) {
        return;
    }
    
    const { error } = await supabase
        .from(PERFIS_TABLE)
        .update({ status: newStatus })
        .eq('id', userId);

    if (error) {
        console.error('Erro ao atualizar status:', error);
        return alert('Falha ao atualizar o status. Verifique RLS de UPDATE na tabela "perfis".');
    }
    
    alert(`Usuário marcado como: ${newStatus}.`);
    loadAprovacaoPanel(); 
}


// ** 5. Funções de Compressão e Envio de Entrega **

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(resolve, 'image/jpeg', 0.7); 
            };
            img.onerror = reject; 
            img.src = event.target.result;
        };
        reader.onerror = reject; 
        reader.readAsDataURL(file);
    });
}

async function addPhotoFromInput(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('photos-preview');
    const statusDiv = document.getElementById('photo-status');
    statusDiv.textContent = ''; 
    
    if (!file) return;

    statusDiv.textContent = 'Processando e compactando foto...';
    
    try {
        const compressedBlob = await compressImage(file);
        
        const photoName = `photo_${Date.now()}.jpg`;
        const compressedFile = new File([compressedBlob], photoName, { type: 'image/jpeg' });

        photosToUpload.push(compressedFile);

        const imgUrl = URL.createObjectURL(compressedBlob);
        
        const photoContainer = document.createElement('div');
        photoContainer.style = 'position: relative;';
        
        const imgElement = document.createElement('img');
        imgElement.src = imgUrl;
        imgElement.style = 'max-width: 80px; max-height: 80px; height: auto; border: 1px solid #333;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style = 'position: absolute; top: -5px; right: -5px; background-color: red; border-radius: 50%; width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 10px; cursor: pointer;';
        deleteBtn.onclick = function() {
            const index = photosToUpload.indexOf(compressedFile);
            if (index > -1) {
                photosToUpload.splice(index, 1);
            }
            previewDiv.removeChild(photoContainer);
            URL.revokeObjectURL(imgUrl); 
            if (photosToUpload.length === 0) {
                 statusDiv.textContent = 'Nenhuma foto anexada.';
            } else {
                statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
            }
        };

        photoContainer.appendChild(imgElement);
        photoContainer.appendChild(deleteBtn);
        previewDiv.appendChild(photoContainer);

        statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
        
    } catch (e) {
        console.error('Erro ao adicionar foto:', e);
        statusDiv.textContent = 'Erro ao processar a foto.';
    } finally {
        event.target.value = '';
    }
}

async function submitDelivery() {
    if (signaturePad.isEmpty()) {
        return alert("Assinatura do cliente é obrigatória.");
    }
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const cliente = document.getElementById('cliente').value.trim();
    
    const fotoFiles = photosToUpload; 

    if (!pedido || !endereco || !cliente || fotoFiles.length === 0) {
        return alert("Todos os campos e pelo menos uma foto são obrigatórios.");
    }

    // 1. Inserir a Entrega PRINCIPAL (para obter o ID)
    let entregaId;
    const { data: entregaData, error: dbError } = await supabase
        .from(ENTREGAS_TABLE) 
        .insert([{
            numero_pedido: pedido,
            endereco: endereco,
            nome_cliente: cliente,
            assinatura_base64: signaturePad.toDataURL('image/png')
        }])
        .select('id') 
        .single();

    if (dbError) {
        console.error('Erro ao registrar a entrega no banco (Principal):', dbError);
        return alert('Erro ao registrar a entrega principal no banco.');
    }
    entregaId = entregaData.id;

    const fotosParaInserir = []; 
    let uploadSuccessCount = 0;
    
    // 2. Loop para processar e enviar CADA FOTO do array temporário
    for (const compressedFile of fotoFiles) {
        try {
            const photoPath = `public/${entregaId}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}.jpg`; 
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(photoPath, compressedFile, { cacheControl: '3600', upsert: false });

            if (uploadError) {
                console.warn(`Falha no upload da foto: ${uploadError.message}.`);
                continue; 
            }

            // Obter URL
            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(photoPath);

            fotosParaInserir.push({
                entrega_id: entregaId,
                url: publicUrlData.publicUrl
            });
            uploadSuccessCount++;

        } catch (e) {
            console.error('Erro durante processamento da foto:', e);
            continue; 
        }
    }

    // 3. Salvar as URLs das Fotos na tabela 'fotos_comprovantes'
    if (fotosParaInserir.length > 0) {
        const { error: fotosError } = await supabase
            .from(FOTOS_TABLE)
            .insert(fotosParaInserir);

        if (fotosError) {
            console.error('Erro ao salvar as URLs das fotos:', fotosError);
            alert(`Atenção: A entrega principal foi salva, mas ${uploadSuccessCount} foto(s) não foram linkadas corretamente ao pedido!`);
        }
    }

    alert(`Entrega ${pedido} registrada com sucesso. ${uploadSuccessCount} foto(s) enviada(s)!`);
    
    // 4. Limpar o formulário e a lista temporária
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
    document.getElementById('cliente').value = '';
    signaturePad.clear();
    
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
    document.getElementById('photo-status').textContent = ''; 
}


// ** 7. Funções do Gerente (Histórico e Delete) **

async function fetchDeliveries(searchQuery = '') {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = 'Carregando pedidos...';
    
    let query = supabase
        .from(ENTREGAS_TABLE)
        .select('id, numero_pedido, nome_cliente, created_at')
        .order('created_at', { ascending: false });

    if (searchQuery) {
        query = query.ilike('numero_pedido', `%${searchQuery}%`);
    }

    const { data, error } = await query;

    if (error) {
        console.error('Erro ao carregar pedidos:', error);
        listDiv.innerHTML = 'Erro ao carregar pedidos.';
        return;
    }

    renderDeliveryList(data);
}

function renderDeliveryList(deliveries) {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = ''; 
    
    if (deliveries.length === 0) {
        listDiv.innerHTML = `<p>Nenhum pedido encontrado ${document.getElementById('search-input').value ? 'com este número.' : '.'}</p>`;
        return;
    }

    deliveries.forEach(item => {
        const date = new Date(item.created_at).toLocaleString('pt-BR');
        
        const card = document.createElement('div');
        card.className = 'pedido-card';
        card.innerHTML = `
            <div onclick="showDeliveryDetails('${item.id}', '${item.numero_pedido}')" style="flex-grow: 1; margin-right: 10px;">
                <strong>Pedido N°: ${item.numero_pedido}</strong> - ${item.nome_cliente}
                <span style="float: right; color: #666; font-size: 0.9em;">${date}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteDelivery('${item.id}', '${item.numero_pedido}')" 
                    class="delete-btn">
                Excluir
            </button>
        `;
        listDiv.appendChild(card);
    });
}

function searchDeliveries() {
    const query = document.getElementById('search-input').value.trim();
    if (query.length >= 3 || query.length === 0) {
        fetchDeliveries(query);
    }
}

async function showDeliveryDetails(entregaId, numeroPedido) {
    const detalhesDiv = document.getElementById('detalhes-pedido');
    const conteudoDiv = document.getElementById('detalhes-conteudo');
    
    document.getElementById('pedido-numero-detalhe').textContent = numeroPedido;
    detalhesDiv.classList.remove('hidden');
    conteudoDiv.innerHTML = 'Carregando detalhes...';

    const { data: entregaData, error: entregaError } = await supabase
        .from(ENTREGAS_TABLE)
        .select('*')
        .eq('id', entregaId)
        .single();
    
    const { data: fotosData, error: fotosError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (entregaError || fotosError) {
        console.error('Erro ao carregar detalhes:', entregaError || fotosError);
        conteudoDiv.innerHTML = '<p style="color: red;">Falha ao carregar os detalhes do pedido. Verifique RLS de SELECT nas tabelas.</p>';
        return;
    }
    
    let fotosHtml = '<h4>Fotos:</h4><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
    if (fotosData.length === 0) {
        fotosHtml += '<p>Nenhuma foto anexada para este pedido.</p>';
    } else {
        fotosData.forEach(foto => {
            fotosHtml += `<img src="${foto.url}" style="max-width: 150px; max-height: 150px; height: auto; border: 1px solid #333; cursor: pointer;" onclick="window.open('${foto.url}', '_blank')">`;
        });
    }
    fotosHtml += '</div>';

    // Monta o Conteúdo Final (Assinatura com estilo inline corrigido)
    conteudoDiv.innerHTML = `
        <p><strong>Endereço:</strong> ${entregaData.endereco}</p>
        <p><strong>Recebedor:</strong> ${entregaData.nome_cliente}</p>
        <p><strong>Registro:</strong> ${new Date(entregaData.created_at).toLocaleString('pt-BR')}</p>
        
        ${fotosHtml}
        
        <h4 style="margin-top: 15px; margin-bottom: 5px;">Assinatura:</h4>
        <div style="
            margin: 0 auto 20px auto; 
            max-width: 270px; 
            box-sizing: border-box; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: white; 
            text-align: center;
        ">
            <img 
                src="${entregaData.assinatura_base64}" 
                style="
                    max-width: 100%; 
                    height: 100px; 
                    padding: 0; 
                    display: block; 
                "
            >
        </div>
    `;
}

async function downloadComprovante() {
    const elementoParaCapturar = document.getElementById('detalhes-conteudo');
    const pedidoNumero = document.getElementById('pedido-numero-detalhe').textContent;

    if (document.getElementById('detalhes-pedido').classList.contains('hidden')) {
        return alert('Selecione um pedido primeiro.');
    }

    document.getElementById('download-btn').style.display = 'none';

    try {
        const canvas = await html2canvas(elementoParaCapturar, {
            scale: 2, 
            useCORS: true 
        });

        const imgData = canvas.toDataURL('image/jpeg');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        pdf.save(`Comprovante_Pedido_${pedidoNumero}.pdf`);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Houve um erro ao gerar o comprovante. Verifique o console.');
    } finally {
        document.getElementById('download-btn').style.display = 'block';
    }
}


async function deleteDelivery(entregaId, numeroPedido) {
    if (!confirm(`Tem certeza que deseja EXCLUIR o pedido N° ${numeroPedido} e todas as suas fotos? Esta ação é IRREVERSÍVEL.`)) {
        return;
    }

    // 1. Buscar fotos para obter os caminhos do Storage
    const { data: fotosData, error: fotosFetchError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (fotosFetchError) {
        console.error('Erro ao buscar fotos para exclusão:', fotosFetchError);
        alert('Erro ao buscar fotos. Exclusão abortada.');
        return;
    }
    
    // 2. Excluir arquivos do Supabase Storage
    const filesToDelete = fotosData.map(foto => {
        const parts = foto.url.split(`${BUCKET_NAME}/`);
        return parts.length > 1 ? parts[1] : null;
    }).filter(path => path); 

    if (filesToDelete.length > 0) {
        const { error: storageDelError } = await supabase.storage
            .from(BUCKET_NAME)
            .remove(filesToDelete);
        
        if (storageDelError) {
            console.warn('AVISO: Falha ao excluir arquivos do Storage. Eles podem ter permanecido no bucket. Verifique RLS de DELETE do Storage.', storageDelError);
            alert('Aviso: Falha ao excluir arquivos do Storage. Verifique se a Política RLS de DELETE do Storage está correta.');
        }
    }
    
    // 3. Excluir registros do banco (ordem: filhos primeiro, pai depois)
    
    // Excluir registros da tabela 'fotos_comprovantes' (FILHO)
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .eq('entrega_id', entregaId);

    if (fotosDelError) {
        console.error('Erro ao excluir registros de fotos:', fotosDelError);
        alert(`Erro ao excluir registros de fotos para ${numeroPedido}.`);
        return;
    }

    // Excluir registro principal da tabela 'entregas' (PAI)
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .eq('id', entregaId);

    if (entregaDelError) {
        console.error('Erro ao excluir registro principal:', entregaDelError);
        alert(`Erro ao excluir pedido principal ${numeroPedido}.`);
        return;
    }

    alert(`Pedido N° ${numeroPedido} excluído com sucesso!`);
    
    // Atualiza a lista
    fetchDeliveries(document.getElementById('search-input').value.trim());
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** NOVO: Função para Excluir TODOS os Pedidos **
async function deleteAllDeliveries() {
    if (!confirm("CONFIRMAÇÃO EXTREMA: Você está prestes a EXCLUIR TODOS OS PEDIDOS E FOTOS. Esta ação é IRREVERSÍVEL.")) {
        return;
    }
    const confirmationText = prompt("Para confirmar a exclusão TOTAL, digite 'DELETAR TUDO' na caixa abaixo:");
    
    if (confirmationText !== 'DELETAR TUDO') {
        return alert('Exclusão total cancelada.');
    }

    // 1. Excluir todos os registros de fotos
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (fotosDelError) {
        console.error('Erro ao excluir TODAS as fotos:', fotosDelError);
        return alert('Erro ao excluir todos os registros de fotos. Verifique as Políticas RLS de DELETE.');
    }
    
    // 2. Excluir todos os registros da tabela 'entregas'
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (entregaDelError) {
        console.error('Erro ao excluir TODOS os pedidos:', entregaDelError);
        return alert('Erro ao excluir todos os pedidos. Verifique as Políticas RLS de DELETE.');
    }

    alert('TODOS os pedidos foram excluídos com sucesso do banco de dados! Lembre-se de limpar o bucket "comprovantes" no Storage do Supabase se desejar remover os arquivos.');
    
    // Atualiza a lista
    fetchDeliveries();
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** Lógica de Adicionar Foto e Envio **

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(resolve, 'image/jpeg', 0.7); 
            };
            img.onerror = reject; 
            img.src = event.target.result;
        };
        reader.onerror = reject; 
        reader.readAsDataURL(file);
    });
}

async function addPhotoFromInput(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('photos-preview');
    const statusDiv = document.getElementById('photo-status');
    statusDiv.textContent = ''; 
    
    if (!file) return;

    statusDiv.textContent = 'Processando e compactando foto...';
    
    try {
        const compressedBlob = await compressImage(file);
        
        const photoName = `photo_${Date.now()}.jpg`;
        const compressedFile = new File([compressedBlob], photoName, { type: 'image/jpeg' });

        photosToUpload.push(compressedFile);

        const imgUrl = URL.createObjectURL(compressedBlob);
        
        const photoContainer = document.createElement('div');
        photoContainer.style = 'position: relative;';
        
        const imgElement = document.createElement('img');
        imgElement.src = imgUrl;
        imgElement.style = 'max-width: 80px; max-height: 80px; height: auto; border: 1px solid #333;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style = 'position: absolute; top: -5px; right: -5px; background-color: red; border-radius: 50%; width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 10px; cursor: pointer;';
        deleteBtn.onclick = function() {
            const index = photosToUpload.indexOf(compressedFile);
            if (index > -1) {
                photosToUpload.splice(index, 1);
            }
            previewDiv.removeChild(photoContainer);
            URL.revokeObjectURL(imgUrl); 
            if (photosToUpload.length === 0) {
                 statusDiv.textContent = 'Nenhuma foto anexada.';
            } else {
                statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
            }
        };

        photoContainer.appendChild(imgElement);
        photoContainer.appendChild(deleteBtn);
        previewDiv.appendChild(photoContainer);

        statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
        
    } catch (e) {
        console.error('Erro ao adicionar foto:', e);
        statusDiv.textContent = 'Erro ao processar a foto.';
    } finally {
        event.target.value = '';
    }
}

async function submitDelivery() {
    if (signaturePad.isEmpty()) {
        return alert("Assinatura do cliente é obrigatória.");
    }
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const cliente = document.getElementById('cliente').value.trim();
    
    const fotoFiles = photosToUpload; 

    if (!pedido || !endereco || !cliente || fotoFiles.length === 0) {
        return alert("Todos os campos e pelo menos uma foto são obrigatórios.");
    }

    // 1. Inserir a Entrega PRINCIPAL (para obter o ID)
    let entregaId;
    const { data: entregaData, error: dbError } = await supabase
        .from(ENTREGAS_TABLE) 
        .insert([{
            numero_pedido: pedido,
            endereco: endereco,
            nome_cliente: cliente,
            assinatura_base64: signaturePad.toDataURL('image/png')
        }])
        .select('id') 
        .single();

    if (dbError) {
        console.error('Erro ao registrar a entrega no banco (Principal):', dbError);
        return alert('Erro ao registrar a entrega principal no banco.');
    }
    entregaId = entregaData.id;

    const fotosParaInserir = []; 
    let uploadSuccessCount = 0;
    
    // 2. Loop para processar e enviar CADA FOTO do array temporário
    for (const compressedFile of fotoFiles) {
        try {
            const photoPath = `public/${entregaId}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}.jpg`; 
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(photoPath, compressedFile, { cacheControl: '3600', upsert: false });

            if (uploadError) {
                console.warn(`Falha no upload da foto: ${uploadError.message}.`);
                continue; 
            }

            // Obter URL
            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(photoPath);

            fotosParaInserir.push({
                entrega_id: entregaId,
                url: publicUrlData.publicUrl
            });
            uploadSuccessCount++;

        } catch (e) {
            console.error('Erro durante processamento da foto:', e);
            continue; 
        }
    }

    // 3. Salvar as URLs das Fotos na tabela 'fotos_comprovantes'
    if (fotosParaInserir.length > 0) {
        const { error: fotosError } = await supabase
            .from(FOTOS_TABLE)
            .insert(fotosParaInserir);

        if (fotosError) {
            console.error('Erro ao salvar as URLs das fotos:', fotosError);
            alert(`Atenção: A entrega principal foi salva, mas ${uploadSuccessCount} foto(s) não foram linkadas corretamente ao pedido!`);
        }
    }

    alert(`Entrega ${pedido} registrada com sucesso. ${uploadSuccessCount} foto(s) enviada(s)!`);
    
    // 4. Limpar o formulário e a lista temporária
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
    document.getElementById('cliente').value = '';
    signaturePad.clear();
    
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
    document.getElementById('photo-status').textContent = ''; 
}


// ** 7. Funções do Gerente (Histórico e Delete) **

async function fetchDeliveries(searchQuery = '') {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = 'Carregando pedidos...';
    
    let query = supabase
        .from(ENTREGAS_TABLE)
        .select('id, numero_pedido, nome_cliente, created_at')
        .order('created_at', { ascending: false });

    if (searchQuery) {
        query = query.ilike('numero_pedido', `%${searchQuery}%`);
    }

    const { data, error } = await query;

    if (error) {
        console.error('Erro ao carregar pedidos:', error);
        listDiv.innerHTML = 'Erro ao carregar pedidos.';
        return;
    }

    renderDeliveryList(data);
}

function renderDeliveryList(deliveries) {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = ''; 
    
    if (deliveries.length === 0) {
        listDiv.innerHTML = `<p>Nenhum pedido encontrado ${document.getElementById('search-input').value ? 'com este número.' : '.'}</p>`;
        return;
    }

    deliveries.forEach(item => {
        const date = new Date(item.created_at).toLocaleString('pt-BR');
        
        const card = document.createElement('div');
        card.className = 'pedido-card';
        card.innerHTML = `
            <div onclick="showDeliveryDetails('${item.id}', '${item.numero_pedido}')" style="flex-grow: 1; margin-right: 10px;">
                <strong>Pedido N°: ${item.numero_pedido}</strong> - ${item.nome_cliente}
                <span style="float: right; color: #666; font-size: 0.9em;">${date}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteDelivery('${item.id}', '${item.numero_pedido}')" 
                    class="delete-btn">
                Excluir
            </button>
        `;
        listDiv.appendChild(card);
    });
}

function searchDeliveries() {
    const query = document.getElementById('search-input').value.trim();
    if (query.length >= 3 || query.length === 0) {
        fetchDeliveries(query);
    }
}

async function showDeliveryDetails(entregaId, numeroPedido) {
    const detalhesDiv = document.getElementById('detalhes-pedido');
    const conteudoDiv = document.getElementById('detalhes-conteudo');
    
    document.getElementById('pedido-numero-detalhe').textContent = numeroPedido;
    detalhesDiv.classList.remove('hidden');
    conteudoDiv.innerHTML = 'Carregando detalhes...';

    const { data: entregaData, error: entregaError } = await supabase
        .from(ENTREGAS_TABLE)
        .select('*')
        .eq('id', entregaId)
        .single();
    
    const { data: fotosData, error: fotosError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (entregaError || fotosError) {
        console.error('Erro ao carregar detalhes:', entregaError || fotosError);
        conteudoDiv.innerHTML = '<p style="color: red;">Falha ao carregar os detalhes do pedido. Verifique RLS de SELECT nas tabelas.</p>';
        return;
    }
    
    let fotosHtml = '<h4>Fotos:</h4><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
    if (fotosData.length === 0) {
        fotosHtml += '<p>Nenhuma foto anexada para este pedido.</p>';
    } else {
        fotosData.forEach(foto => {
            fotosHtml += `<img src="${foto.url}" style="max-width: 150px; max-height: 150px; height: auto; border: 1px solid #333; cursor: pointer;" onclick="window.open('${foto.url}', '_blank')">`;
        });
    }
    fotosHtml += '</div>';

    // Monta o Conteúdo Final (Assinatura com estilo inline corrigido)
    conteudoDiv.innerHTML = `
        <p><strong>Endereço:</strong> ${entregaData.endereco}</p>
        <p><strong>Recebedor:</strong> ${entregaData.nome_cliente}</p>
        <p><strong>Registro:</strong> ${new Date(entregaData.created_at).toLocaleString('pt-BR')}</p>
        
        ${fotosHtml}
        
        <h4 style="margin-top: 15px; margin-bottom: 5px;">Assinatura:</h4>
        <div style="
            margin: 0 auto 20px auto; 
            max-width: 270px; 
            box-sizing: border-box; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: white; 
            text-align: center;
        ">
            <img 
                src="${entregaData.assinatura_base64}" 
                style="
                    max-width: 100%; 
                    height: 100px; 
                    padding: 0; 
                    display: block; 
                "
            >
        </div>
    `;
}

async function downloadComprovante() {
    const elementoParaCapturar = document.getElementById('detalhes-conteudo');
    const pedidoNumero = document.getElementById('pedido-numero-detalhe').textContent;

    if (document.getElementById('detalhes-pedido').classList.contains('hidden')) {
        return alert('Selecione um pedido primeiro.');
    }

    document.getElementById('download-btn').style.display = 'none';

    try {
        const canvas = await html2canvas(elementoParaCapturar, {
            scale: 2, 
            useCORS: true 
        });

        const imgData = canvas.toDataURL('image/jpeg');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        pdf.save(`Comprovante_Pedido_${pedidoNumero}.pdf`);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Houve um erro ao gerar o comprovante. Verifique o console.');
    } finally {
        document.getElementById('download-btn').style.display = 'block';
    }
}


async function deleteDelivery(entregaId, numeroPedido) {
    if (!confirm(`Tem certeza que deseja EXCLUIR o pedido N° ${numeroPedido} e todas as suas fotos? Esta ação é IRREVERSÍVEL.`)) {
        return;
    }

    // 1. Buscar fotos para obter os caminhos do Storage
    const { data: fotosData, error: fotosFetchError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (fotosFetchError) {
        console.error('Erro ao buscar fotos para exclusão:', fotosFetchError);
        alert('Erro ao buscar fotos. Exclusão abortada.');
        return;
    }
    
    // 2. Excluir arquivos do Supabase Storage
    const filesToDelete = fotosData.map(foto => {
        const parts = foto.url.split(`${BUCKET_NAME}/`);
        return parts.length > 1 ? parts[1] : null;
    }).filter(path => path); 

    if (filesToDelete.length > 0) {
        const { error: storageDelError } = await supabase.storage
            .from(BUCKET_NAME)
            .remove(filesToDelete);
        
        if (storageDelError) {
            console.warn('AVISO: Falha ao excluir arquivos do Storage. Eles podem ter permanecido no bucket. Verifique RLS de DELETE do Storage.', storageDelError);
            alert('Aviso: Falha ao excluir arquivos do Storage. Verifique se a Política RLS de DELETE do Storage está correta.');
        }
    }
    
    // 3. Excluir registros do banco (ordem: filhos primeiro, pai depois)
    
    // Excluir registros da tabela 'fotos_comprovantes' (FILHO)
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .eq('entrega_id', entregaId);

    if (fotosDelError) {
        console.error('Erro ao excluir registros de fotos:', fotosDelError);
        alert(`Erro ao excluir registros de fotos para ${numeroPedido}.`);
        return;
    }

    // Excluir registro principal da tabela 'entregas' (PAI)
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .eq('id', entregaId);

    if (entregaDelError) {
        console.error('Erro ao excluir registro principal:', entregaDelError);
        alert(`Erro ao excluir pedido principal ${numeroPedido}.`);
        return;
    }

    alert(`Pedido N° ${numeroPedido} excluído com sucesso!`);
    
    // Atualiza a lista
    fetchDeliveries(document.getElementById('search-input').value.trim());
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** NOVO: Função para Excluir TODOS os Pedidos **
async function deleteAllDeliveries() {
    if (!confirm("CONFIRMAÇÃO EXTREMA: Você está prestes a EXCLUIR TODOS OS PEDIDOS E FOTOS. Esta ação é IRREVERSÍVEL.")) {
        return;
    }
    const confirmationText = prompt("Para confirmar a exclusão TOTAL, digite 'DELETAR TUDO' na caixa abaixo:");
    
    if (confirmationText !== 'DELETAR TUDO') {
        return alert('Exclusão total cancelada.');
    }

    // 1. Excluir todos os registros de fotos
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (fotosDelError) {
        console.error('Erro ao excluir TODAS as fotos:', fotosDelError);
        return alert('Erro ao excluir todos os registros de fotos. Verifique as Políticas RLS de DELETE.');
    }
    
    // 2. Excluir todos os registros da tabela 'entregas'
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (entregaDelError) {
        console.error('Erro ao excluir TODOS os pedidos:', entregaDelError);
        return alert('Erro ao excluir todos os pedidos. Verifique as Políticas RLS de DELETE.');
    }

    alert('TODOS os pedidos foram excluídos com sucesso do banco de dados! Lembre-se de limpar o bucket "comprovantes" no Storage do Supabase se desejar remover os arquivos.');
    
    // Atualiza a lista
    fetchDeliveries();
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** Lógica de Adicionar Foto e Envio **

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(resolve, 'image/jpeg', 0.7); 
            };
            img.onerror = reject; 
            img.src = event.target.result;
        };
        reader.onerror = reject; 
        reader.readAsDataURL(file);
    });
}

async function addPhotoFromInput(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('photos-preview');
    const statusDiv = document.getElementById('photo-status');
    statusDiv.textContent = ''; 
    
    if (!file) return;

    statusDiv.textContent = 'Processando e compactando foto...';
    
    try {
        const compressedBlob = await compressImage(file);
        
        const photoName = `photo_${Date.now()}.jpg`;
        const compressedFile = new File([compressedBlob], photoName, { type: 'image/jpeg' });

        photosToUpload.push(compressedFile);

        const imgUrl = URL.createObjectURL(compressedBlob);
        
        const photoContainer = document.createElement('div');
        photoContainer.style = 'position: relative;';
        
        const imgElement = document.createElement('img');
        imgElement.src = imgUrl;
        imgElement.style = 'max-width: 80px; max-height: 80px; height: auto; border: 1px solid #333;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style = 'position: absolute; top: -5px; right: -5px; background-color: red; border-radius: 50%; width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 10px; cursor: pointer;';
        deleteBtn.onclick = function() {
            const index = photosToUpload.indexOf(compressedFile);
            if (index > -1) {
                photosToUpload.splice(index, 1);
            }
            previewDiv.removeChild(photoContainer);
            URL.revokeObjectURL(imgUrl); 
            if (photosToUpload.length === 0) {
                 statusDiv.textContent = 'Nenhuma foto anexada.';
            } else {
                statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
            }
        };

        photoContainer.appendChild(imgElement);
        photoContainer.appendChild(deleteBtn);
        previewDiv.appendChild(photoContainer);

        statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
        
    } catch (e) {
        console.error('Erro ao adicionar foto:', e);
        statusDiv.textContent = 'Erro ao processar a foto.';
    } finally {
        event.target.value = '';
    }
}

async function submitDelivery() {
    if (signaturePad.isEmpty()) {
        return alert("Assinatura do cliente é obrigatória.");
    }
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const cliente = document.getElementById('cliente').value.trim();
    
    const fotoFiles = photosToUpload; 

    if (!pedido || !endereco || !cliente || fotoFiles.length === 0) {
        return alert("Todos os campos e pelo menos uma foto são obrigatórios.");
    }

    // 1. Inserir a Entrega PRINCIPAL (para obter o ID)
    let entregaId;
    const { data: entregaData, error: dbError } = await supabase
        .from(ENTREGAS_TABLE) 
        .insert([{
            numero_pedido: pedido,
            endereco: endereco,
            nome_cliente: cliente,
            assinatura_base64: signaturePad.toDataURL('image/png')
        }])
        .select('id') 
        .single();

    if (dbError) {
        console.error('Erro ao registrar a entrega no banco (Principal):', dbError);
        return alert('Erro ao registrar a entrega principal no banco.');
    }
    entregaId = entregaData.id;

    const fotosParaInserir = []; 
    let uploadSuccessCount = 0;
    
    // 2. Loop para processar e enviar CADA FOTO do array temporário
    for (const compressedFile of fotoFiles) {
        try {
            const photoPath = `public/${entregaId}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}.jpg`; 
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(photoPath, compressedFile, { cacheControl: '3600', upsert: false });

            if (uploadError) {
                console.warn(`Falha no upload da foto: ${uploadError.message}.`);
                continue; 
            }

            // Obter URL
            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(photoPath);

            fotosParaInserir.push({
                entrega_id: entregaId,
                url: publicUrlData.publicUrl
            });
            uploadSuccessCount++;

        } catch (e) {
            console.error('Erro durante processamento da foto:', e);
            continue; 
        }
    }

    // 3. Salvar as URLs das Fotos na tabela 'fotos_comprovantes'
    if (fotosParaInserir.length > 0) {
        const { error: fotosError } = await supabase
            .from(FOTOS_TABLE)
            .insert(fotosParaInserir);

        if (fotosError) {
            console.error('Erro ao salvar as URLs das fotos:', fotosError);
            alert(`Atenção: A entrega principal foi salva, mas ${uploadSuccessCount} foto(s) não foram linkadas corretamente ao pedido!`);
        }
    }

    alert(`Entrega ${pedido} registrada com sucesso. ${uploadSuccessCount} foto(s) enviada(s)!`);
    
    // 4. Limpar o formulário e a lista temporária
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
    document.getElementById('cliente').value = '';
    signaturePad.clear();
    
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
    document.getElementById('photo-status').textContent = ''; 
}


// ** 7. Funções do Gerente (Histórico e Delete) **

async function fetchDeliveries(searchQuery = '') {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = 'Carregando pedidos...';
    
    let query = supabase
        .from(ENTREGAS_TABLE)
        .select('id, numero_pedido, nome_cliente, created_at')
        .order('created_at', { ascending: false });

    if (searchQuery) {
        query = query.ilike('numero_pedido', `%${searchQuery}%`);
    }

    const { data, error } = await query;

    if (error) {
        console.error('Erro ao carregar pedidos:', error);
        listDiv.innerHTML = 'Erro ao carregar pedidos.';
        return;
    }

    renderDeliveryList(data);
}

function renderDeliveryList(deliveries) {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = ''; 
    
    if (deliveries.length === 0) {
        listDiv.innerHTML = `<p>Nenhum pedido encontrado ${document.getElementById('search-input').value ? 'com este número.' : '.'}</p>`;
        return;
    }

    deliveries.forEach(item => {
        const date = new Date(item.created_at).toLocaleString('pt-BR');
        
        const card = document.createElement('div');
        card.className = 'pedido-card';
        card.innerHTML = `
            <div onclick="showDeliveryDetails('${item.id}', '${item.numero_pedido}')" style="flex-grow: 1; margin-right: 10px;">
                <strong>Pedido N°: ${item.numero_pedido}</strong> - ${item.nome_cliente}
                <span style="float: right; color: #666; font-size: 0.9em;">${date}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteDelivery('${item.id}', '${item.numero_pedido}')" 
                    class="delete-btn">
                Excluir
            </button>
        `;
        listDiv.appendChild(card);
    });
}

function searchDeliveries() {
    const query = document.getElementById('search-input').value.trim();
    if (query.length >= 3 || query.length === 0) {
        fetchDeliveries(query);
    }
}

async function showDeliveryDetails(entregaId, numeroPedido) {
    const detalhesDiv = document.getElementById('detalhes-pedido');
    const conteudoDiv = document.getElementById('detalhes-conteudo');
    
    document.getElementById('pedido-numero-detalhe').textContent = numeroPedido;
    detalhesDiv.classList.remove('hidden');
    conteudoDiv.innerHTML = 'Carregando detalhes...';

    const { data: entregaData, error: entregaError } = await supabase
        .from(ENTREGAS_TABLE)
        .select('*')
        .eq('id', entregaId)
        .single();
    
    const { data: fotosData, error: fotosError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (entregaError || fotosError) {
        console.error('Erro ao carregar detalhes:', entregaError || fotosError);
        conteudoDiv.innerHTML = '<p style="color: red;">Falha ao carregar os detalhes do pedido. Verifique RLS de SELECT nas tabelas.</p>';
        return;
    }
    
    let fotosHtml = '<h4>Fotos:</h4><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
    if (fotosData.length === 0) {
        fotosHtml += '<p>Nenhuma foto anexada para este pedido.</p>';
    } else {
        fotosData.forEach(foto => {
            fotosHtml += `<img src="${foto.url}" style="max-width: 150px; max-height: 150px; height: auto; border: 1px solid #333; cursor: pointer;" onclick="window.open('${foto.url}', '_blank')">`;
        });
    }
    fotosHtml += '</div>';

    // Monta o Conteúdo Final (Assinatura com estilo inline corrigido)
    conteudoDiv.innerHTML = `
        <p><strong>Endereço:</strong> ${entregaData.endereco}</p>
        <p><strong>Recebedor:</strong> ${entregaData.nome_cliente}</p>
        <p><strong>Registro:</strong> ${new Date(entregaData.created_at).toLocaleString('pt-BR')}</p>
        
        ${fotosHtml}
        
        <h4 style="margin-top: 15px; margin-bottom: 5px;">Assinatura:</h4>
        <div style="
            margin: 0 auto 20px auto; 
            max-width: 270px; 
            box-sizing: border-box; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: white; 
            text-align: center;
        ">
            <img 
                src="${entregaData.assinatura_base64}" 
                style="
                    max-width: 100%; 
                    height: 100px; 
                    padding: 0; 
                    display: block; 
                "
            >
        </div>
    `;
}

async function downloadComprovante() {
    const elementoParaCapturar = document.getElementById('detalhes-conteudo');
    const pedidoNumero = document.getElementById('pedido-numero-detalhe').textContent;

    if (document.getElementById('detalhes-pedido').classList.contains('hidden')) {
        return alert('Selecione um pedido primeiro.');
    }

    document.getElementById('download-btn').style.display = 'none';

    try {
        const canvas = await html2canvas(elementoParaCapturar, {
            scale: 2, 
            useCORS: true 
        });

        const imgData = canvas.toDataURL('image/jpeg');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        pdf.save(`Comprovante_Pedido_${pedidoNumero}.pdf`);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Houve um erro ao gerar o comprovante. Verifique o console.');
    } finally {
        document.getElementById('download-btn').style.display = 'block';
    }
}


async function deleteDelivery(entregaId, numeroPedido) {
    if (!confirm(`Tem certeza que deseja EXCLUIR o pedido N° ${numeroPedido} e todas as suas fotos? Esta ação é IRREVERSÍVEL.`)) {
        return;
    }

    // 1. Buscar fotos para obter os caminhos do Storage
    const { data: fotosData, error: fotosFetchError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (fotosFetchError) {
        console.error('Erro ao buscar fotos para exclusão:', fotosFetchError);
        alert('Erro ao buscar fotos. Exclusão abortada.');
        return;
    }
    
    // 2. Excluir arquivos do Supabase Storage
    const filesToDelete = fotosData.map(foto => {
        const parts = foto.url.split(`${BUCKET_NAME}/`);
        return parts.length > 1 ? parts[1] : null;
    }).filter(path => path); 

    if (filesToDelete.length > 0) {
        const { error: storageDelError } = await supabase.storage
            .from(BUCKET_NAME)
            .remove(filesToDelete);
        
        if (storageDelError) {
            console.warn('AVISO: Falha ao excluir arquivos do Storage. Eles podem ter permanecido no bucket. Verifique RLS de DELETE do Storage.', storageDelError);
            alert('Aviso: Falha ao excluir arquivos do Storage. Verifique se a Política RLS de DELETE do Storage está correta.');
        }
    }
    
    // 3. Excluir registros do banco (ordem: filhos primeiro, pai depois)
    
    // Excluir registros da tabela 'fotos_comprovantes' (FILHO)
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .eq('entrega_id', entregaId);

    if (fotosDelError) {
        console.error('Erro ao excluir registros de fotos:', fotosDelError);
        alert(`Erro ao excluir registros de fotos para ${numeroPedido}.`);
        return;
    }

    // Excluir registro principal da tabela 'entregas' (PAI)
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .eq('id', entregaId);

    if (entregaDelError) {
        console.error('Erro ao excluir registro principal:', entregaDelError);
        alert(`Erro ao excluir pedido principal ${numeroPedido}.`);
        return;
    }

    alert(`Pedido N° ${numeroPedido} excluído com sucesso!`);
    
    // Atualiza a lista
    fetchDeliveries(document.getElementById('search-input').value.trim());
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** NOVO: Função para Excluir TODOS os Pedidos **
async function deleteAllDeliveries() {
    if (!confirm("CONFIRMAÇÃO EXTREMA: Você está prestes a EXCLUIR TODOS OS PEDIDOS E FOTOS. Esta ação é IRREVERSÍVEL.")) {
        return;
    }
    const confirmationText = prompt("Para confirmar a exclusão TOTAL, digite 'DELETAR TUDO' na caixa abaixo:");
    
    if (confirmationText !== 'DELETAR TUDO') {
        return alert('Exclusão total cancelada.');
    }

    // 1. Excluir todos os registros de fotos
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (fotosDelError) {
        console.error('Erro ao excluir TODAS as fotos:', fotosDelError);
        return alert('Erro ao excluir todos os registros de fotos. Verifique as Políticas RLS de DELETE.');
    }
    
    // 2. Excluir todos os registros da tabela 'entregas'
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (entregaDelError) {
        console.error('Erro ao excluir TODOS os pedidos:', entregaDelError);
        return alert('Erro ao excluir todos os pedidos. Verifique as Políticas RLS de DELETE.');
    }

    alert('TODOS os pedidos foram excluídos com sucesso do banco de dados! Lembre-se de limpar o bucket "comprovantes" no Storage do Supabase se desejar remover os arquivos.');
    
    // Atualiza a lista
    fetchDeliveries();
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** Lógica de Adicionar Foto e Envio **

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(resolve, 'image/jpeg', 0.7); 
            };
            img.onerror = reject; 
            img.src = event.target.result;
        };
        reader.onerror = reject; 
        reader.readAsDataURL(file);
    });
}

async function addPhotoFromInput(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('photos-preview');
    const statusDiv = document.getElementById('photo-status');
    statusDiv.textContent = ''; 
    
    if (!file) return;

    statusDiv.textContent = 'Processando e compactando foto...';
    
    try {
        const compressedBlob = await compressImage(file);
        
        const photoName = `photo_${Date.now()}.jpg`;
        const compressedFile = new File([compressedBlob], photoName, { type: 'image/jpeg' });

        photosToUpload.push(compressedFile);

        const imgUrl = URL.createObjectURL(compressedBlob);
        
        const photoContainer = document.createElement('div');
        photoContainer.style = 'position: relative;';
        
        const imgElement = document.createElement('img');
        imgElement.src = imgUrl;
        imgElement.style = 'max-width: 80px; max-height: 80px; height: auto; border: 1px solid #333;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style = 'position: absolute; top: -5px; right: -5px; background-color: red; border-radius: 50%; width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 10px; cursor: pointer;';
        deleteBtn.onclick = function() {
            const index = photosToUpload.indexOf(compressedFile);
            if (index > -1) {
                photosToUpload.splice(index, 1);
            }
            previewDiv.removeChild(photoContainer);
            URL.revokeObjectURL(imgUrl); 
            if (photosToUpload.length === 0) {
                 statusDiv.textContent = 'Nenhuma foto anexada.';
            } else {
                statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
            }
        };

        photoContainer.appendChild(imgElement);
        photoContainer.appendChild(deleteBtn);
        previewDiv.appendChild(photoContainer);

        statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
        
    } catch (e) {
        console.error('Erro ao adicionar foto:', e);
        statusDiv.textContent = 'Erro ao processar a foto.';
    } finally {
        event.target.value = '';
    }
}

async function submitDelivery() {
    if (signaturePad.isEmpty()) {
        return alert("Assinatura do cliente é obrigatória.");
    }
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const cliente = document.getElementById('cliente').value.trim();
    
    const fotoFiles = photosToUpload; 

    if (!pedido || !endereco || !cliente || fotoFiles.length === 0) {
        return alert("Todos os campos e pelo menos uma foto são obrigatórios.");
    }

    // 1. Inserir a Entrega PRINCIPAL (para obter o ID)
    let entregaId;
    const { data: entregaData, error: dbError } = await supabase
        .from(ENTREGAS_TABLE) 
        .insert([{
            numero_pedido: pedido,
            endereco: endereco,
            nome_cliente: cliente,
            assinatura_base64: signaturePad.toDataURL('image/png')
        }])
        .select('id') 
        .single();

    if (dbError) {
        console.error('Erro ao registrar a entrega no banco (Principal):', dbError);
        return alert('Erro ao registrar a entrega principal no banco.');
    }
    entregaId = entregaData.id;

    const fotosParaInserir = []; 
    let uploadSuccessCount = 0;
    
    // 2. Loop para processar e enviar CADA FOTO do array temporário
    for (const compressedFile of fotoFiles) {
        try {
            const photoPath = `public/${entregaId}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}.jpg`; 
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(photoPath, compressedFile, { cacheControl: '3600', upsert: false });

            if (uploadError) {
                console.warn(`Falha no upload da foto: ${uploadError.message}.`);
                continue; 
            }

            // Obter URL
            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(photoPath);

            fotosParaInserir.push({
                entrega_id: entregaId,
                url: publicUrlData.publicUrl
            });
            uploadSuccessCount++;

        } catch (e) {
            console.error('Erro durante processamento da foto:', e);
            continue; 
        }
    }

    // 3. Salvar as URLs das Fotos na tabela 'fotos_comprovantes'
    if (fotosParaInserir.length > 0) {
        const { error: fotosError } = await supabase
            .from(FOTOS_TABLE)
            .insert(fotosParaInserir);

        if (fotosError) {
            console.error('Erro ao salvar as URLs das fotos:', fotosError);
            alert(`Atenção: A entrega principal foi salva, mas ${uploadSuccessCount} foto(s) não foram linkadas corretamente ao pedido!`);
        }
    }

    alert(`Entrega ${pedido} registrada com sucesso. ${uploadSuccessCount} foto(s) enviada(s)!`);
    
    // 4. Limpar o formulário e a lista temporária
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
    document.getElementById('cliente').value = '';
    signaturePad.clear();
    
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
    document.getElementById('photo-status').textContent = ''; 
}


// ** 7. Funções do Gerente (Histórico e Delete) **

async function fetchDeliveries(searchQuery = '') {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = 'Carregando pedidos...';
    
    let query = supabase
        .from(ENTREGAS_TABLE)
        .select('id, numero_pedido, nome_cliente, created_at')
        .order('created_at', { ascending: false });

    if (searchQuery) {
        query = query.ilike('numero_pedido', `%${searchQuery}%`);
    }

    const { data, error } = await query;

    if (error) {
        console.error('Erro ao carregar pedidos:', error);
        listDiv.innerHTML = 'Erro ao carregar pedidos.';
        return;
    }

    renderDeliveryList(data);
}

function renderDeliveryList(deliveries) {
    const listDiv = document.getElementById('historico-list');
    listDiv.innerHTML = ''; 
    
    if (deliveries.length === 0) {
        listDiv.innerHTML = `<p>Nenhum pedido encontrado ${document.getElementById('search-input').value ? 'com este número.' : '.'}</p>`;
        return;
    }

    deliveries.forEach(item => {
        const date = new Date(item.created_at).toLocaleString('pt-BR');
        
        const card = document.createElement('div');
        card.className = 'pedido-card';
        card.innerHTML = `
            <div onclick="showDeliveryDetails('${item.id}', '${item.numero_pedido}')" style="flex-grow: 1; margin-right: 10px;">
                <strong>Pedido N°: ${item.numero_pedido}</strong> - ${item.nome_cliente}
                <span style="float: right; color: #666; font-size: 0.9em;">${date}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteDelivery('${item.id}', '${item.numero_pedido}')" 
                    class="delete-btn">
                Excluir
            </button>
        `;
        listDiv.appendChild(card);
    });
}

function searchDeliveries() {
    const query = document.getElementById('search-input').value.trim();
    if (query.length >= 3 || query.length === 0) {
        fetchDeliveries(query);
    }
}

async function showDeliveryDetails(entregaId, numeroPedido) {
    const detalhesDiv = document.getElementById('detalhes-pedido');
    const conteudoDiv = document.getElementById('detalhes-conteudo');
    
    document.getElementById('pedido-numero-detalhe').textContent = numeroPedido;
    detalhesDiv.classList.remove('hidden');
    conteudoDiv.innerHTML = 'Carregando detalhes...';

    const { data: entregaData, error: entregaError } = await supabase
        .from(ENTREGAS_TABLE)
        .select('*')
        .eq('id', entregaId)
        .single();
    
    const { data: fotosData, error: fotosError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (entregaError || fotosError) {
        console.error('Erro ao carregar detalhes:', entregaError || fotosError);
        conteudoDiv.innerHTML = '<p style="color: red;">Falha ao carregar os detalhes do pedido. Verifique RLS de SELECT nas tabelas.</p>';
        return;
    }
    
    let fotosHtml = '<h4>Fotos:</h4><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
    if (fotosData.length === 0) {
        fotosHtml += '<p>Nenhuma foto anexada para este pedido.</p>';
    } else {
        fotosData.forEach(foto => {
            fotosHtml += `<img src="${foto.url}" style="max-width: 150px; max-height: 150px; height: auto; border: 1px solid #333; cursor: pointer;" onclick="window.open('${foto.url}', '_blank')">`;
        });
    }
    fotosHtml += '</div>';

    // Monta o Conteúdo Final (Assinatura com estilo inline corrigido)
    conteudoDiv.innerHTML = `
        <p><strong>Endereço:</strong> ${entregaData.endereco}</p>
        <p><strong>Recebedor:</strong> ${entregaData.nome_cliente}</p>
        <p><strong>Registro:</strong> ${new Date(entregaData.created_at).toLocaleString('pt-BR')}</p>
        
        ${fotosHtml}
        
        <h4 style="margin-top: 15px; margin-bottom: 5px;">Assinatura:</h4>
        <div style="
            margin: 0 auto 20px auto; 
            max-width: 270px; 
            box-sizing: border-box; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background-color: white; 
            text-align: center;
        ">
            <img 
                src="${entregaData.assinatura_base64}" 
                style="
                    max-width: 100%; 
                    height: 100px; 
                    padding: 0; 
                    display: block; 
                "
            >
        </div>
    `;
}

async function downloadComprovante() {
    const elementoParaCapturar = document.getElementById('detalhes-conteudo');
    const pedidoNumero = document.getElementById('pedido-numero-detalhe').textContent;

    if (document.getElementById('detalhes-pedido').classList.contains('hidden')) {
        return alert('Selecione um pedido primeiro.');
    }

    document.getElementById('download-btn').style.display = 'none';

    try {
        const canvas = await html2canvas(elementoParaCapturar, {
            scale: 2, 
            useCORS: true 
        });

        const imgData = canvas.toDataURL('image/jpeg');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        pdf.save(`Comprovante_Pedido_${pedidoNumero}.pdf`);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Houve um erro ao gerar o comprovante. Verifique o console.');
    } finally {
        document.getElementById('download-btn').style.display = 'block';
    }
}


async function deleteDelivery(entregaId, numeroPedido) {
    if (!confirm(`Tem certeza que deseja EXCLUIR o pedido N° ${numeroPedido} e todas as suas fotos? Esta ação é IRREVERSÍVEL.`)) {
        return;
    }

    // 1. Buscar fotos para obter os caminhos do Storage
    const { data: fotosData, error: fotosFetchError } = await supabase
        .from(FOTOS_TABLE)
        .select('url')
        .eq('entrega_id', entregaId);

    if (fotosFetchError) {
        console.error('Erro ao buscar fotos para exclusão:', fotosFetchError);
        alert('Erro ao buscar fotos. Exclusão abortada.');
        return;
    }
    
    // 2. Excluir arquivos do Supabase Storage
    const filesToDelete = fotosData.map(foto => {
        const parts = foto.url.split(`${BUCKET_NAME}/`);
        return parts.length > 1 ? parts[1] : null;
    }).filter(path => path); 

    if (filesToDelete.length > 0) {
        const { error: storageDelError } = await supabase.storage
            .from(BUCKET_NAME)
            .remove(filesToDelete);
        
        if (storageDelError) {
            console.warn('AVISO: Falha ao excluir arquivos do Storage. Eles podem ter permanecido no bucket. Verifique RLS de DELETE do Storage.', storageDelError);
            alert('Aviso: Falha ao excluir arquivos do Storage. Verifique se a Política RLS de DELETE do Storage está correta.');
        }
    }
    
    // 3. Excluir registros do banco (ordem: filhos primeiro, pai depois)
    
    // Excluir registros da tabela 'fotos_comprovantes' (FILHO)
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .eq('entrega_id', entregaId);

    if (fotosDelError) {
        console.error('Erro ao excluir registros de fotos:', fotosDelError);
        alert(`Erro ao excluir registros de fotos para ${numeroPedido}.`);
        return;
    }

    // Excluir registro principal da tabela 'entregas' (PAI)
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .eq('id', entregaId);

    if (entregaDelError) {
        console.error('Erro ao excluir registro principal:', entregaDelError);
        alert(`Erro ao excluir pedido principal ${numeroPedido}.`);
        return;
    }

    alert(`Pedido N° ${numeroPedido} excluído com sucesso!`);
    
    // Atualiza a lista
    fetchDeliveries(document.getElementById('search-input').value.trim());
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** NOVO: Função para Excluir TODOS os Pedidos **
async function deleteAllDeliveries() {
    if (!confirm("CONFIRMAÇÃO EXTREMA: Você está prestes a EXCLUIR TODOS OS PEDIDOS E FOTOS. Esta ação é IRREVERSÍVEL.")) {
        return;
    }
    const confirmationText = prompt("Para confirmar a exclusão TOTAL, digite 'DELETAR TUDO' na caixa abaixo:");
    
    if (confirmationText !== 'DELETAR TUDO') {
        return alert('Exclusão total cancelada.');
    }

    // 1. Excluir todos os registros de fotos
    const { error: fotosDelError } = await supabase
        .from(FOTOS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (fotosDelError) {
        console.error('Erro ao excluir TODAS as fotos:', fotosDelError);
        return alert('Erro ao excluir todos os registros de fotos. Verifique as Políticas RLS de DELETE.');
    }
    
    // 2. Excluir todos os registros da tabela 'entregas'
    const { error: entregaDelError } = await supabase
        .from(ENTREGAS_TABLE)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); 

    if (entregaDelError) {
        console.error('Erro ao excluir TODOS os pedidos:', entregaDelError);
        return alert('Erro ao excluir todos os pedidos. Verifique as Políticas RLS de DELETE.');
    }

    alert('TODOS os pedidos foram excluídos com sucesso do banco de dados! Lembre-se de limpar o bucket "comprovantes" no Storage do Supabase se desejar remover os arquivos.');
    
    // Atualiza a lista
    fetchDeliveries();
    document.getElementById('detalhes-pedido').classList.add('hidden');
}

// ** Lógica de Adicionar Foto e Envio **

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(resolve, 'image/jpeg', 0.7); 
            };
            img.onerror = reject; 
            img.src = event.target.result;
        };
        reader.onerror = reject; 
        reader.readAsDataURL(file);
    });
}

async function addPhotoFromInput(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('photos-preview');
    const statusDiv = document.getElementById('photo-status');
    statusDiv.textContent = ''; 
    
    if (!file) return;

    statusDiv.textContent = 'Processando e compactando foto...';
    
    try {
        const compressedBlob = await compressImage(file);
        
        const photoName = `photo_${Date.now()}.jpg`;
        const compressedFile = new File([compressedBlob], photoName, { type: 'image/jpeg' });

        photosToUpload.push(compressedFile);

        const imgUrl = URL.createObjectURL(compressedBlob);
        
        const photoContainer = document.createElement('div');
        photoContainer.style = 'position: relative;';
        
        const imgElement = document.createElement('img');
        imgElement.src = imgUrl;
        imgElement.style = 'max-width: 80px; max-height: 80px; height: auto; border: 1px solid #333;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style = 'position: absolute; top: -5px; right: -5px; background-color: red; border-radius: 50%; width: 20px; height: 20px; padding: 0; line-height: 1; font-size: 10px; cursor: pointer;';
        deleteBtn.onclick = function() {
            const index = photosToUpload.indexOf(compressedFile);
            if (index > -1) {
                photosToUpload.splice(index, 1);
            }
            previewDiv.removeChild(photoContainer);
            URL.revokeObjectURL(imgUrl); 
            if (photosToUpload.length === 0) {
                 statusDiv.textContent = 'Nenhuma foto anexada.';
            } else {
                statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
            }
        };

        photoContainer.appendChild(imgElement);
        photoContainer.appendChild(deleteBtn);
        previewDiv.appendChild(photoContainer);

        statusDiv.textContent = `${photosToUpload.length} foto(s) anexada(s).`;
        
    } catch (e) {
        console.error('Erro ao adicionar foto:', e);
        statusDiv.textContent = 'Erro ao processar a foto.';
    } finally {
        event.target.value = '';
    }
}

async function submitDelivery() {
    if (signaturePad.isEmpty()) {
        return alert("Assinatura do cliente é obrigatória.");
    }
    const pedido = document.getElementById('pedido').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const cliente = document.getElementById('cliente').value.trim();
    
    const fotoFiles = photosToUpload; 

    if (!pedido || !endereco || !cliente || fotoFiles.length === 0) {
        return alert("Todos os campos e pelo menos uma foto são obrigatórios.");
    }

    // 1. Inserir a Entrega PRINCIPAL (para obter o ID)
    let entregaId;
    const { data: entregaData, error: dbError } = await supabase
        .from(ENTREGAS_TABLE) 
        .insert([{
            numero_pedido: pedido,
            endereco: endereco,
            nome_cliente: cliente,
            assinatura_base64: signaturePad.toDataURL('image/png')
        }])
        .select('id') 
        .single();

    if (dbError) {
        console.error('Erro ao registrar a entrega no banco (Principal):', dbError);
        return alert('Erro ao registrar a entrega principal no banco.');
    }
    entregaId = entregaData.id;

    const fotosParaInserir = []; 
    let uploadSuccessCount = 0;
    
    // 2. Loop para processar e enviar CADA FOTO do array temporário
    for (const compressedFile of fotoFiles) {
        try {
            const photoPath = `public/${entregaId}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}.jpg`; 
            
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(photoPath, compressedFile, { cacheControl: '3600', upsert: false });

            if (uploadError) {
                console.warn(`Falha no upload da foto: ${uploadError.message}.`);
                continue; 
            }

            // Obter URL
            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(photoPath);

            fotosParaInserir.push({
                entrega_id: entregaId,
                url: publicUrlData.publicUrl
            });
            uploadSuccessCount++;

        } catch (e) {
            console.error('Erro durante processamento da foto:', e);
            continue; 
        }
    }

    // 3. Salvar as URLs das Fotos na tabela 'fotos_comprovantes'
    if (fotosParaInserir.length > 0) {
        const { error: fotosError } = await supabase
            .from(FOTOS_TABLE)
            .insert(fotosParaInserir);

        if (fotosError) {
            console.error('Erro ao salvar as URLs das fotos:', fotosError);
            alert(`Atenção: A entrega principal foi salva, mas ${uploadSuccessCount} foto(s) não foram linkadas corretamente ao pedido!`);
        }
    }

    alert(`Entrega ${pedido} registrada com sucesso. ${uploadSuccessCount} foto(s) enviada(s)!`);
    
    // 4. Limpar o formulário e a lista temporária
    document.getElementById('pedido').value = '';
    document.getElementById('endereco').value = '';
    document.getElementById('cliente').value = '';
    signaturePad.clear();
    
    photosToUpload = []; 
    document.getElementById('photos-preview').innerHTML = ''; 
    document.getElementById('photo-status').textContent = ''; 
}


// ** EVENT LISTENER para a nova função de foto sequencial **
document.getElementById('single-photo-input').addEventListener('change', addPhotoFromInput);

</script>
</body>
</html>
